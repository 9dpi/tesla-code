<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MẬT MÃ TESLA | THẦN SỐ HỌC VŨ TRỤ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --tesla-accent: #00f2ff;
            --accent-rgb: 0, 242, 255;
            --bg-deep: #05070a;
            --card-bg: #11161d;
        }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
            appearance: none;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: var(--bg-deep);
            color: #fff;
            font-family: 'Segoe UI', system-ui, sans-serif;
            margin: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        body,
        .glass-card,
        .btn-primary,
        .tesla-card-1to1,
        h1,
        h2,
        input,
        .hint-box {
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .app-container {
            width: 100%;
            max-width: 400px;
            padding: 20px;
            z-index: 10;
        }

        .glass-card {
            background: var(--card-bg);
            border: 1px solid rgba(var(--accent-rgb), 0.2);
            border-radius: 30px;
            padding: 35px 20px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
        }

        h1 {
            font-size: 1.2rem;
            letter-spacing: 5px;
            color: var(--tesla-accent);
            margin-bottom: 30px;
            font-weight: 300;
        }

        .label-tiny {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: rgba(255, 255, 255, 0.3);
            margin-bottom: 15px;
            display: block;
        }

        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }

        .input-row input {
            background: #000;
            border: 1px solid #222;
            border-radius: 12px;
            color: var(--tesla-accent);
            font-size: 1.3rem;
            width: 100%;
            text-align: center;
            padding: 15px 0;
            outline: none;
        }

        .input-row input:focus {
            border-color: var(--tesla-accent);
            box-shadow: 0 0 15px rgba(var(--accent-rgb), 0.2);
        }

        .gender-switch {
            display: flex;
            background: #000;
            border-radius: 50px;
            padding: 4px;
            border: 1px solid #222;
            margin-bottom: 35px;
        }

        .gender-btn {
            flex: 1;
            padding: 12px;
            cursor: pointer;
            border-radius: 50px;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.4);
        }

        .gender-switch input {
            display: none;
        }

        .gender-switch input:checked+.gender-btn {
            color: #000;
            font-weight: bold;
            background: var(--tesla-accent);
            box-shadow: 0 0 15px var(--tesla-accent);
        }

        .tesla-card-1to1 {
            width: 100%;
            aspect-ratio: 1/1;
            background: radial-gradient(circle at center, rgba(var(--accent-rgb), 0.1) 0%, #000 100%);
            border-radius: 20px;
            border: 1px solid rgba(var(--accent-rgb), 0.3);
            margin-bottom: 25px;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow: hidden;
        }

        .card-num {
            font-size: 6.5rem;
            font-weight: bold;
            color: var(--tesla-accent);
            text-shadow: 0 0 40px var(--tesla-accent);
            margin: 0;
        }

        .card-footer {
            position: absolute;
            bottom: 20px;
            width: 100%;
            display: flex;
            justify-content: space-around;
            font-size: 0.65rem;
            opacity: 0.5;
            letter-spacing: 1px;
        }

        .btn-primary {
            width: 100%;
            padding: 18px;
            border-radius: 50px;
            border: none;
            background: var(--tesla-accent);
            color: #000;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(var(--accent-rgb), 0.3);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .btn-row {
            display: flex;
            gap: 10px;
            justify-content: space-between;
            margin-top: 10px;
        }

        .btn-outline {
            flex: 1;
            background: transparent;
            border: 1px solid #333;
            color: #fff;
            padding: 12px;
            border-radius: 50px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn-outline:active {
            background: rgba(255, 255, 255, 0.1);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--card-bg);
            border: 1px solid var(--tesla-accent);
            border-radius: 35px;
            padding: 30px;
            text-align: center;
            max-width: 320px;
            width: 90%;
        }

        .qr-image {
            width: 100%;
            border-radius: 15px;
            margin: 15px 0;
            border: 2px solid var(--tesla-accent);
        }

        .hidden {
            display: none;
        }

        .hint-box {
            background: rgba(var(--accent-rgb), 0.03);
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
            font-size: 0.9rem;
            line-height: 1.6;
            border-left: 4px solid var(--tesla-accent);
            color: #ddd;
        }
    </style>
</head>

<body>

    <div class="app-container">
        <div id="scr-1" class="glass-card">
            <h1>TESLA CODE</h1>
            <span class="label-tiny">Mật mã ngày sinh</span>
            <div class="input-row">
                <input type="number" id="d" placeholder="DD" inputmode="numeric">
                <input type="number" id="m" placeholder="MM" inputmode="numeric">
                <input type="number" id="y" placeholder="YYYY" inputmode="numeric">
            </div>
            <span class="label-tiny">Bản thể năng lượng</span>
            <div class="gender-switch">
                <label style="flex:1"><input type="radio" name="gen" value="NAM" checked>
                    <div class="gender-btn">NAM</div>
                </label>
                <label style="flex:1"><input type="radio" name="gen" value="NỮ">
                    <div class="gender-btn">NỮ</div>
                </label>
            </div>
            <button class="btn-primary" onclick="toStep2()">KÍCH HOẠT TẦN SỐ</button>
        </div>

        <div id="scr-2" class="glass-card hidden">
            <div style="font-size: 4rem; color: var(--tesla-accent); font-weight: bold; text-shadow: 0 0 20px var(--tesla-accent);"
                id="out-num">0</div>
            <h2 id="out-title"
                style="color:var(--tesla-accent); font-weight: 300; margin: 5px 0 20px; font-size: 1.1rem;"></h2>
            <div class="hint-box" id="out-hint"></div>
            <hr style="border: 0; border-top: 1px solid #222; margin: 25px 0;">
            <span class="label-tiny">Con số bạn bắt gặp lúc này?</span>
            <input type="number" id="ins-num"
                style="background:#000; border:1px dashed var(--tesla-accent); color:#fff; width:100%; padding:18px; border-radius:15px; text-align:center; margin-bottom:25px; font-size:2rem; outline:none;"
                placeholder="369">
            <button class="btn-primary" onclick="toStep3()">GIẢI MÃ THẦN SỐ</button>
        </div>

        <div id="scr-3" class="glass-card hidden">
            <div id="capture-area" class="tesla-card-1to1">
                <h1 class="card-num" id="card-num-final"></h1>
                <div id="card-status"
                    style="z-index:2; font-size:0.8rem; letter-spacing:3px; color:var(--tesla-accent); margin-top:10px; font-weight: 300;">
                </div>
                <div class="card-footer">
                    <span id="res-date"></span>
                    <span id="res-ins" style="color: var(--tesla-accent); font-weight: bold;"></span>
                </div>
            </div>
            <div class="hint-box" id="ai-reading"
                style="border-left:none; border-right:4px solid var(--tesla-accent); text-align:right;"></div>

            <button class="btn-primary"
                style="background: linear-gradient(45deg, var(--tesla-accent), #fff); color:#000;"
                onclick="toggleModal(true)">NẠP PIN VŨ TRỤ</button>

            <div class="btn-row">
                <button class="btn-outline" onclick="downloadCard()">LƯU CARD</button>
                <button class="btn-outline" onclick="shareApp()">CHIA SẺ</button>
            </div>

            <p onclick="location.reload()"
                style="font-size:0.6rem; margin-top:30px; opacity:0.3; cursor:pointer; letter-spacing:2px;">KHỞI TẠO LẠI
            </p>
        </div>
    </div>

    <div class="modal" id="donate-modal">
        <div class="modal-content">
            <h3 style="color:var(--tesla-accent); margin:0; letter-spacing:2px; font-size: 1.1rem;">TIẾP NĂNG LƯỢNG</h3>
            <p style="font-size:0.75rem; opacity:0.7; margin:10px 0;">Quét mã để nạp pin cho Trạm phát Tesla</p>
            <img src="https://lh3.googleusercontent.com/d/1egscXEcGdy9sR3pm13RlO1gZQMLdqdjF" class="qr-image"
                alt="QR Donate">
            <button class="btn-primary" onclick="toggleModal(false)">XÁC NHẬN</button>
        </div>
    </div>

    <script>
        const themes = {
            2: { c: "#E0E0E0", rgb: "224, 224, 224", t: "Người Kết Nối", h: "Trực giác là vũ khí mạnh nhất của bạn." },
            11: { c: "#E0E0E0", rgb: "224, 224, 224", t: "Người Truyền Cảm Hứng", h: "Tần số tâm linh cao vượt bậc." },
            3: { c: "#FF8C00", rgb: "255, 140, 0", t: "Nhà Truyền Tin", h: "Sáng tạo là dòng máu chảy trong bạn." },
            5: { c: "#FF8C00", rgb: "255, 140, 0", t: "Kẻ Khai Phá", h: "Tự do là bản chất vốn có." },
            4: { c: "#FFD700", rgb: "255, 215, 0", t: "Người Kiến Tạo", h: "Sự vững chãi tạo nên di sản." },
            8: { c: "#FFD700", rgb: "255, 215, 0", t: "Người Điều Hành", h: "Quyền năng chuyển hóa vật chất." },
            6: { c: "#20B2AA", rgb: "32, 178, 170", t: "Nhà Kiến Tạo Tận Tâm", h: "Sức mạnh của sự chữa lành." },
            9: { c: "#20B2AA", rgb: "32, 178, 170", t: "Người Phụng Sự", h: "Cho đi là nhận lại trọn vẹn." },
            7: { c: "#00F2FF", rgb: "0, 242, 255", t: "Nhà Thông Thái", h: "Tĩnh lặng để thấu thị vạn vật." },
            10: { c: "#00F2FF", rgb: "0, 242, 255", t: "Nhà Lãnh Đạo", h: "Thích nghi chính là sức mạnh." }
        };

        function applyTheme(n) {
            const theme = themes[n] || themes[7];
            document.documentElement.style.setProperty('--tesla-accent', theme.c);
            document.documentElement.style.setProperty('--accent-rgb', theme.rgb);
        }

        function calculate(d, m, y) {
            let sum = [...(d + m + y)].reduce((a, b) => a + parseInt(b), 0);
            while (sum > 11) sum = [...sum.toString()].reduce((a, b) => a + parseInt(b), 0);
            return sum;
        }

        function toStep2() {
            const dI = document.getElementById('d').value, mI = document.getElementById('m').value, yI = document.getElementById('y').value;
            if (!dI || !mI || !yI) return alert("Nhập mật mã ngày sinh!");
            let n = calculate(dI, mI, yI);
            applyTheme(n);
            document.getElementById('out-num').innerText = n;
            document.getElementById('out-title').innerText = themes[n].t.toUpperCase();
            document.getElementById('out-hint').innerText = themes[n].h;
            document.getElementById('scr-1').classList.add('hidden');
            document.getElementById('scr-2').classList.remove('hidden');
        }

        // 1. KHO DỮ LIỆU GỐC (THE CORE WISDOM) - Gốc rễ của Thần số học
        const coreWisdom = {
            2: "Sức mạnh của bạn nằm ở sự hòa giải và thấu cảm. Tần số của bạn đang thu hút những kết nối tâm giao.",
            3: "Trí tuệ sáng tạo của bạn đang ở đỉnh cao. Vũ trụ muốn bạn dùng ngôn từ để thắp sáng hy vọng.",
            4: "Kỷ luật và sự vững chãi là chìa khóa. Một nền móng quan trọng đang được hình thành dưới chân bạn.",
            5: "Sự tự do và đổi mới đang gọi tên. Đừng sợ hãi những bước ngoặt, đó là dòng chảy của tiến hóa.",
            6: "Năng lượng chữa lành đang lan tỏa. Hãy dùng tình yêu thương làm kim chỉ nam cho mọi quyết định.",
            7: "Sự tĩnh lặng sẽ mang lại câu trả lời. Bạn đang chạm tới ngưỡng cửa của sự thông thái tối thượng.",
            8: "Quyền năng điều hành và vật chất đang hội tụ. Hãy giữ tâm thế công bằng để đón nhận thịnh vượng.",
            9: "Một chu kỳ đang khép lại để mở ra đại lộ mới. Sự bao dung sẽ giúp bạn thăng hoa tần số.",
            10: "Bản lĩnh lãnh đạo tiềm ẩn trong bạn đang trỗi dậy. Hãy sẵn sàng để tiên phong dẫn dắt.",
            11: "Bạn là kênh dẫn của ánh sáng tâm linh. Những ý tưởng trực giác lúc này chính là mật mã vũ trụ."
        };

        // Kho hành động dự phòng (Backup Actions) khi nghẽn API
        const backupActions = [
            "Hãy quan sát hơi thở và thực hiện một hành động tử tế vô điều kiện trong hôm nay.",
            "Viết xuống 3 mục tiêu quan trọng nhất và bắt đầu thực hiện ngay sau khi mặt trời mọc.",
            "Tắt mọi thiết bị điện tử trong 30 phút để kết nối lại với bản thể thực thụ của bạn."
        ];

        async function getTeslaReading(num, ins) {
            let apiKey = localStorage.getItem('tesla_key');
            const coreText = coreWisdom[num] || coreWisdom[7]; // Lấy cái Gốc thần số học

            // Nếu không có Key hoặc nghẽn, trả về kết quả ghép Hybrid Tĩnh
            if (!apiKey) {
                return `<b>Thông điệp Gốc:</b> ${coreText}<br><br><b>Mật mã hành động:</b> ${backupActions[Math.floor(Math.random() * backupActions.length)]}`;
            }

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;

            // Prompt yêu cầu AI kết hợp cái Gốc có sẵn và biến hóa theo số tức thời
            const pText = `
        Bối cảnh: Bạn là Tesla. 
        Gốc rễ thần số học số ${num}: "${coreText}".
        Dấu hiệu người dùng thấy: ${ins}.
        Nhiệm vụ: Hãy viết một lời luận giải kết hợp giữa ý nghĩa gốc của số ${num} và dấu hiệu ${ins}.
        Yêu cầu: Giọng văn uy nghi, dùng ngôn từ năng lượng, đưa ra 1 hành động thực thi cụ thể. 
        Độ dài: Tối đa 120 từ.
    `;

            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: pText }] }] }),
                    signal: AbortSignal.timeout(6000)
                });

                if (!res.ok) throw new Error();
                const data = await res.json();
                return data.candidates[0].content.parts[0].text;
            } catch (e) {
                // Fallback Magic: Ghép Gốc tĩnh + Hành động tĩnh (Vẫn cực kỳ tự nhiên)
                return `<b>Thông điệp Gốc:</b> ${coreText}<br><br><b>Mật mã hành động:</b> ${backupActions[Math.floor(Math.random() * backupActions.length)]}`;
            }
        }

        async function toStep3() {
            let ins = document.getElementById('ins-num').value;
            if (!ins) return alert("Nhập con số bạn bắt gặp!");
            let n = document.getElementById('out-num').innerText;
            document.getElementById('scr-2').classList.add('hidden');
            document.getElementById('scr-3').classList.remove('hidden');
            document.getElementById('ai-reading').innerHTML = "<i>Đang truy xuất bản ghi Akashic...</i>";
            document.getElementById('card-num-final').innerText = n;
            document.getElementById('card-status').innerText = themes[n].t.toUpperCase();
            document.getElementById('res-date').innerText = `${document.getElementById('d').value}.${document.getElementById('m').value}.${document.getElementById('y').value}`;
            document.getElementById('res-ins').innerText = "#" + ins;
            const read = await getTeslaReading(n, ins);
            document.getElementById('ai-reading').innerHTML = read;
        }

        function downloadCard() {
            const area = document.getElementById('capture-area');
            html2canvas(area, { backgroundColor: '#05070a', scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = `TeslaCode-${document.getElementById('card-num-final').innerText}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        function shareApp() {
            const text = `Khám phá mật mã Tesla của bạn tại: ${window.location.href}`;
            if (navigator.share) {
                navigator.share({ title: 'Tesla Code', text: text, url: window.location.href });
            } else {
                navigator.clipboard.writeText(text);
                alert("Đã sao chép link chia sẻ!");
            }
        }

        function toggleModal(s) { document.getElementById('donate-modal').style.display = s ? 'flex' : 'none'; }
        document.getElementById('d').oninput = function () { if (this.value.length == 2) document.getElementById('m').focus() };
        document.getElementById('m').oninput = function () { if (this.value.length == 2) document.getElementById('y').focus() };
    </script>
</body>

</html>
